{% extends "base.html" %}

{% block title %}Quản lý Database - Hệ thống Nhận diện Khuôn mặt{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4">
                <i class="fas fa-database text-info me-2"></i>
                Quản lý Database
            </h2>
        </div>
    </div>

    <!-- Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <div class="stats-number">{{ stats.person_count or 0 }}</div>
                    <div>Người đã đăng ký</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-fingerprint fa-2x mb-2"></i>
                    <div class="stats-number">{{ stats.embedding_count or 0 }}</div>
                    <div>Embeddings</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-hdd fa-2x mb-2"></i>
                    <div class="stats-number">{{ "%.2f"|format(stats.database_size_mb or 0) }}</div>
                    <div>Kích thước DB (MB)</div>
                </div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <i class="fas fa-clock fa-2x mb-2"></i>
                    <div class="stats-number">
                        {% if stats.latest_created_at %}
                            {{ stats.latest_created_at[:10] }}
                        {% else %}
                            Chưa có
                        {% endif %}
                    </div>
                    <div>Cập nhật gần nhất</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Thao tác Database
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-primary w-100" onclick="refreshDatabase()">
                                <i class="fas fa-sync me-1"></i>Làm mới
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-success w-100" onclick="backupDatabase()">
                                <i class="fas fa-save me-1"></i>Backup
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-info w-100" onclick="exportDatabase()">
                                <i class="fas fa-download me-1"></i>Export JSON
                            </button>
                        </div>
                        <div class="col-md-3 mb-2">
                            <button class="btn btn-warning w-100" onclick="showImportModal()">
                                <i class="fas fa-upload me-1"></i>Import JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tên...">
                                <button class="btn btn-outline-secondary" onclick="searchPersons()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end">
                                <button class="btn btn-outline-primary me-2" onclick="clearSearch()">
                                    <i class="fas fa-times me-1"></i>Xóa tìm kiếm
                                </button>
                                <button class="btn btn-outline-danger" onclick="deleteAllPersons()">
                                    <i class="fas fa-trash me-1"></i>Xóa tất cả
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Persons List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Danh sách Người dùng
                    </h5>
                </div>
                <div class="card-body">
                    {% if persons %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Tên</th>
                                        <th>Số Embeddings</th>
                                        <th>Số ảnh</th>
                                        <th>Ngày tạo</th>
                                        <th>Ngày cập nhật</th>
                                        <th>Thao tác</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for person in persons %}
                                    <tr>
                                        <td>{{ person.id }}</td>
                                        <td>
                                            <strong>{{ person.name }}</strong>
                                            {% if person.metadata %}
                                                <br><small class="text-muted">
                                                    {% if person.metadata.get('age') %}
                                                        Tuổi: {{ person.metadata.age }}
                                                    {% endif %}
                                                    {% if person.metadata.get('gender') %}
                                                        | Giới tính: {{ person.metadata.gender }}
                                                    {% endif %}
                                                </small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">{{ person.embeddings|length }}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-info">{{ person.image_paths|length }}</span>
                                        </td>
                                        <td>
                                            <small>{{ person.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                        </td>
                                        <td>
                                            <small>{{ person.updated_at.strftime('%d/%m/%Y %H:%M') }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-info" onclick="viewPersonDetails({{ person.id }})" title="Xem chi tiết">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-warning" onclick="editPerson({{ person.id }})" title="Chỉnh sửa">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deletePerson('{{ person.name }}')" title="Xóa">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-database fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Database trống</h5>
                            <p class="text-muted">Chưa có người dùng nào được đăng ký</p>
                            <a href="{{ url_for('enrollment') }}" class="btn btn-primary">
                                <i class="fas fa-user-plus me-1"></i>Đăng ký người dùng đầu tiên
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Person Details Modal -->
<div class="modal fade" id="personDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-user me-2"></i>Chi tiết Người dùng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="personDetailsContent">
                <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div class="modal fade" id="importModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-upload me-2"></i>Import Database
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="importFile" class="form-label">Chọn file JSON</label>
                    <input type="file" class="form-control" id="importFile" accept=".json">
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    File JSON phải có định dạng export từ hệ thống này.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="importDatabase()">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>Xác nhận xóa
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="deleteMessage">Bạn có chắc chắn muốn xóa?</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPersonToDelete = null;

// Search functionality
$('#searchInput').on('keypress', function(e) {
    if (e.which === 13) { // Enter key
        searchPersons();
    }
});

function searchPersons() {
    const query = $('#searchInput').val().trim();
    if (query) {
        // Implement search functionality
        showAlert('Tính năng tìm kiếm đang được phát triển', 'info');
    }
}

function clearSearch() {
    $('#searchInput').val('');
    location.reload();
}

function refreshDatabase() {
    location.reload();
}

function backupDatabase() {
    $.post('/api/database/backup')
        .done(function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
            } else {
                showAlert(response.message, 'danger');
            }
        })
        .fail(function() {
            showAlert('Lỗi kết nối server', 'danger');
        });
}

function exportDatabase() {
    $.post('/api/database/export')
        .done(function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
            } else {
                showAlert(response.message, 'danger');
            }
        })
        .fail(function() {
            showAlert('Lỗi kết nối server', 'danger');
        });
}

function showImportModal() {
    $('#importModal').modal('show');
}

function importDatabase() {
    const fileInput = document.getElementById('importFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Vui lòng chọn file để import', 'danger');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            // Implement import functionality
            showAlert('Tính năng import đang được phát triển', 'info');
        } catch (error) {
            showAlert('File JSON không hợp lệ', 'danger');
        }
    };
    reader.readAsText(file);
}

function viewPersonDetails(personId) {
    // Load person details
    $.get(`/api/database/persons/${personId}`)
        .done(function(response) {
            if (response.success) {
                displayPersonDetails(response.person);
            } else {
                showAlert('Không thể tải thông tin người dùng', 'danger');
            }
        })
        .fail(function() {
            showAlert('Lỗi kết nối server', 'danger');
        });
}

function displayPersonDetails(person) {
    const content = `
        <div class="row">
            <div class="col-md-6">
                <h6>Thông tin cơ bản</h6>
                <table class="table table-sm">
                    <tr><td><strong>ID:</strong></td><td>${person.id}</td></tr>
                    <tr><td><strong>Tên:</strong></td><td>${person.name}</td></tr>
                    <tr><td><strong>Số embeddings:</strong></td><td>${person.embeddings.length}</td></tr>
                    <tr><td><strong>Số ảnh:</strong></td><td>${person.image_paths.length}</td></tr>
                    <tr><td><strong>Ngày tạo:</strong></td><td>${new Date(person.created_at).toLocaleString('vi-VN')}</td></tr>
                    <tr><td><strong>Ngày cập nhật:</strong></td><td>${new Date(person.updated_at).toLocaleString('vi-VN')}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Metadata</h6>
                <pre class="bg-light p-3 rounded">${JSON.stringify(person.metadata, null, 2)}</pre>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>Confidence Scores</h6>
                <div class="row">
                    ${person.confidence_scores.map((score, index) => `
                        <div class="col-md-3 mb-2">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h6>Embedding ${index + 1}</h6>
                                    <div class="progress">
                                        <div class="progress-bar" style="width: ${score * 100}%"></div>
                                    </div>
                                    <small>${(score * 100).toFixed(1)}%</small>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        </div>
    `;
    
    $('#personDetailsContent').html(content);
    $('#personDetailsModal').modal('show');
}

function editPerson(personId) {
    showAlert('Tính năng chỉnh sửa đang được phát triển', 'info');
}

function deletePerson(personName) {
    currentPersonToDelete = personName;
    $('#deleteMessage').text(`Bạn có chắc chắn muốn xóa người dùng "${personName}"?`);
    $('#confirmDeleteBtn').off('click').on('click', confirmDeletePerson);
    $('#deleteModal').modal('show');
}

function confirmDeletePerson() {
    if (currentPersonToDelete) {
        $.ajax({
            url: `/api/database/persons/${currentPersonToDelete}`,
            method: 'DELETE'
        })
        .done(function(response) {
            if (response.success) {
                showAlert(response.message, 'success');
                $('#deleteModal').modal('hide');
                location.reload();
            } else {
                showAlert(response.message, 'danger');
            }
        })
        .fail(function() {
            showAlert('Lỗi kết nối server', 'danger');
        });
    }
}

function deleteAllPersons() {
    currentPersonToDelete = 'ALL';
    $('#deleteMessage').text('Bạn có chắc chắn muốn xóa TẤT CẢ người dùng? Hành động này không thể hoàn tác!');
    $('#confirmDeleteBtn').off('click').on('click', confirmDeleteAll);
    $('#deleteModal').modal('show');
}

function confirmDeleteAll() {
    showAlert('Tính năng xóa tất cả đang được phát triển', 'warning');
    $('#deleteModal').modal('hide');
}
</script>
{% endblock %}
